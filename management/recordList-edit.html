<!DOCTYPE html>
<html>
  
  <head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
    
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <style>
      
  </style>
  <body>
    <div class="x-body">
        <form class="layui-form" lay-filter="example">
          <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>基本信息</legend>
          </fieldset>
          <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">菜名</label>
                <div class="layui-input-inline">
                  <input type="text" name="Name" lay-verify="required|text" autocomplete="off" class="layui-input">
                </div>
              </div>
          </div>
          <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">单位</label>
                <div class="layui-input-inline">
                  <select name="Unit" lay-verify="required">
                    <option value="">请选择</option>
                    <option value="个" >个</option>
                    <option value="15个" >15个</option>
                    <option value="3个" >3个</option>
                    <option value="根">根</option>
                    <option value="杯">杯</option>
                    <option value="份">份</option>
                    <option value="斤">斤</option>
                    <option value="瓶">瓶</option>
                    <option value="听">听</option>
                    <option value="两">两</option>
                    <option value="包">包</option>
                    <option value="包/10个">包/10个</option>
                    <option value="袋">袋</option>
                    <option value="盒">盒</option>
                    <option value="只">只</option>
                    <option value="半只">半只</option>
                    <option value="3只">3只</option>
                    <option value="串">串</option>
                    <option value="块">块</option>
                    <option value="张">张</option>
                  </select>
                </div>
              </div>
          </div>
          
          <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">价格</label>
                <div class="layui-input-inline">
                   <input type="number" lay-verify="required" name="Price" placeholder="￥" autocomplete="off" class="layui-input" onkeyup="value=value.replace(/[^\d\.]/g,'')">
                </div>
              </div>
          </div>
          <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">是否允许下单</label>
                <div class="layui-input-inline">
                   <!-- <input type="checkbox" checked="" name="Indent" lay-skin="switch" lay-filter="switchTest" lay-text="是|否"> -->
                    <input type="radio" name="Indent" value="true" title="是" checked="">
                    <input type="radio" name="Indent" value="false" title="否">
                </div>
              </div>
          </div>
        
          <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>上传图片</legend>
          </fieldset>

          <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">1.图片</label>
                <div class="layui-input-block">
                  <button type="button" class="layui-btn" id="upload1"><i class="layui-icon"></i>上传图片</button><br/>
                  <!-- <button type="button" class="layui-btn layui-btn-warm" id="delImg"><i class="layui-icon"></i>清除图片</button><br/> -->
                  <div class="layui-inline layui-word-aux ">
                      <input id="Picture" type="text" name="Picture" style="display: none;">
                      <img id="img" src="" style="width: 300px; margin-top: 20px;">
                  </div>
                </div>
              </div>
          </div>

          <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
          </fieldset>

          <div class="layui-form-item">
              <label for="L_repass" class="layui-form-label">
              </label>
              <button  class="layui-btn" lay-filter="add" lay-submit="">
                  保存
              </button>
          </div>
        </form>
    </div>
    <script src="common/server.js"></script>
    <script src="common/common.js"></script>
    <script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/xadmin.js"></script>
    <script>

        
        let ID = getUrlParam('Id');   //获取地址栏参数
        let Type = decodeURI( getUrlParam('Type') );
        
        layui.use(['form','layer','upload', 'laydate'], function(){
            $ = layui.jquery;
            let form = layui.form,
            layer = layui.layer,
            upload = layui.upload;

            console.log(ID);
            if(ID != null) {
                let details = sendAjax(Server.service.GetRecipeInfoByID, {'ID': ID})
                form.val('example', details);   //表单初始赋值
                $('#img').attr('src', Server.filepath + details.Picture);
                $('#Picture').val(details.Picture);
            }
      

                //form.render();

            //监听提交
            form.on('submit(add)', function(data){
                let sendData = data.field; 
                sendData.Type = Type;
                console.log(sendData);
                if(sendData.Picture == ''){
                    layer.alert('请上传图片', {icon: 5});
                    return false;
                }

                sendAjax1(Server.service.AddorEditRecipe, {"ID": ID, "jsonStr": JSON.stringify(sendData)}, function(data) {
                    var info = data;
                    //console.log(info);
                    if(info.success == 1) {
                        layer.alert("保存成功", {icon: 6},function () {
                            window.parent.location.reload();
                            var index = parent.layer.getFrameIndex(window.name);  // 获得frame索引
                            parent.layer.close(index);   //关闭当前frame
                        });
                    } else {
                        return layer.alert(info.message, {icon: 5});
                    }
                    
                } )
                
                return false;
            });
       


            //图片上传
            let loadingIndex;
            let oldPath = $('.basicMaterials').val();
            upload.render({
              elem: '#upload1',
              url: Server.service.UploadAll+'?type=1&oldPath=' + oldPath,
              accept: 'images',    //普通文件
              exts: 'jpg|png|gif|bmp|jpeg',
              before: function(obj) {
                  loadingIndex = layer.load(2);  //显示加载层
                  obj.preview(function(index, file, result){
                    $('#img').attr('src', result); //图片链接（base64）
                  });
              },
              done: function(res){
                  var url = JSON.parse(res.resultData);
                  $('.basicMaterials').val(url[0].Url);
                  $('#Picture').val(url[0].Url);
                  //imgUrl = url[0].Url;
                  layer.close(loadingIndex);          //关闭加载层
                  return layer.msg(res.message);
              },
              error: function(){
                  return layer.msg('上传失败');
              }
            });

            
        });

    </script>
    
  </body>

</html>